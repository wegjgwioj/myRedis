# MyRedis

MyRedis 是一个用 Go 实现的类 Redis 键值存储服务器，目标是把“协议解析、执行模型、持久化、过期/淘汰、最小分布式闭环”做成可测试、可复现的工程实现。

## 能力对齐

- **分布式键值**：3 节点一致性哈希分片 + 透明转发（静态节点列表）
- **RESP 协议**：处理 TCP 粘包/拆包，支持管道（Pipeline）
- **可靠性**：AOF 每秒落盘 + 优雅关闭 + 重启恢复
- **内存管理**：LRU/LFU 淘汰 + TTL（惰性删除 + 定期删除）

> 分布式采用“服务端代理转发”模式：客户端只需连接任意节点，即可读写全量 key。  
> 本项目不实现 Redis Cluster 的槽位/MOVED/ASK 协议（该体系还涉及 slot 迁移、Gossip、复制与故障转移联动，范围更大）。

## 模块说明（按功能拆解）

### 1) 网络与协议（TCP + RESP）

- 请求解析为流式：同一连接可连续发送多条命令（管道），并能处理分片到达的输入。
- 回包严格按请求顺序返回，保证管道场景下客户端可按序读取。
- 关注点：解析状态机、错误处理、尽量减少多余拷贝。

### 2) 执行引擎（单线程消息循环 / Actor）

- 网络连接可以并发，但命令执行在单线程消息循环中串行完成，避免并发读写导致的数据竞争。
- 优点：更容易把 TTL、淘汰、持久化这些“跨模块一致性”做对；缺点：吞吐上限受单线程影响（可通过多实例扩展）。

### 3) 过期（TTL）

- 采用“惰性删除 + 定期删除”组合：访问时校验、周期性清理。
- 过期时间采用绝对时间语义写入持久化日志/快照，避免重启导致“续命”。

### 4) 内存淘汰（LRU / LFU）

- 支持按配置选择 LRU 或 LFU；容量受限时自动淘汰。
- LFU 同频率时按“最近最少使用”退化，保证行为可预测、可测试。

### 5) AOF 持久化（每秒落盘）

- 写命令以追加日志方式持久化，后台按固定频率落盘。
- 优雅关闭会尽最大努力把队列写完并完成最终落盘，保证“主动关闭不丢数据”。

### 6) AOF 重写（压缩历史日志）

- 支持将历史日志压缩为“重建当前状态的最小指令集”。
- 后台重写期间的新写入会被完整保留，避免重写替换导致丢数据。

### 7) RDB 快照（全量状态）

- 支持将内存状态写为快照，用于更快加载；与 AOF 互补。
- 快照中也使用绝对过期时间语义，保证重启一致性。

### 8) 分布式（3 节点分片 + 透明转发）

- 一致性哈希决定 key 的归属节点；入口节点负责本地执行或转发到目标节点。
- 当前对单 key 命令透明转发；对多 key 的 `DEL` 支持跨节点分组与结果聚合。
- 不包含：动态扩缩容、槽位迁移、复制、故障转移等完整集群能力。

### 9) 测试与评估（可复现）

- 单元/集成测试覆盖：RESP 拆包/粘包/管道、AOF 刷盘与回放、TTL 语义、LRU/LFU 淘汰语义、分布式透明转发。
- 提供一键评估脚本：默认在本机启动 3 个节点，分别用 LRU/LFU 跑一轮功能验收，并输出评估报告与日志。

## CLI 参数（对外接口）

- `--addr`：监听地址
- `--nodes`：节点列表（空表示单机）
- `--aof`：AOF 文件（空表示关闭）
- `--rdb`：快照文件（空表示关闭）
- `--appendfsync`：AOF 刷盘策略（当前仅支持 `everysec`）
- `--eviction`：淘汰策略（`lru` 或 `lfu`）
- `--max-bytes`：最大内存（字节）
- `--vnodes`：一致性哈希虚拟节点数

## 支持命令（子集）

- String：`PING` `SET` `GET` `DEL`
- List：`LPUSH` `RPUSH` `LPOP` `RPOP` `LRANGE` `LLEN`
- Hash：`HSET` `HGET` `HGETALL` `HDEL`
- Set：`SADD` `SREM` `SCARD` `SMEMBERS`
- TTL：`EXPIRE` `TTL` `PERSIST` `PEXPIREAT`
- Admin：`SHUTDOWN`
- Persistence：`SAVE` `BGSAVE` `REWRITEAOF` `BGREWRITEAOF`

## 限制与后续方向

- 分布式当前为静态分片 + 透明转发，未实现 Redis Cluster 的槽位/MOVED/ASK 协议。
- 高级能力（规划）：复制、故障转移、动态扩缩容、指标与可观测性、更完整命令集等。
